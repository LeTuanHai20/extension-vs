"use strict";var e=this&&this.t||function(t,i,s,e){return new(s||(s=Promise))(function(r,h){function n(t){try{c(e.next(t))}catch(t){h(t)}}function o(t){try{c(e.throw(t))}catch(t){h(t)}}function c(t){var i;t.done?r(t.value):(i=t.value,i instanceof s?i:new s(function(t){t(i)})).then(n,o)}c((e=e.apply(t,i||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const Ut=require("net"),$=require("events"),Kt=require("xmldom"),Ht=require("iconv-lite");exports.D="127.0.0.1",exports.R=9001,exports.U=3e3;class Jt extends $.EventEmitter{constructor(t=exports.D,i=exports.R,s,e,r=!0,h=exports.U){super(),this.M=!0,this.K="utf8",this.H=t,this.J=i,this.L=s,this.N=e,this.M=r,this.T=h}V(t,i){return this.W=new Ut.Socket,new Promise((s,e)=>{this.W.on("data",t=>{let e=new Lt(t,this.K);i(e),s()}),this.W.on("error",t=>{this.W.end(),this.emit("error",t),e(t)}),this.W.on("timeout",()=>{this.W.emit("error","Couldn't establish a connection with DBGp proxy in time."),e()}),this.W.on("close",()=>{this.emit("close")}),this.W.setTimeout(this.T),this.W.connect(this.J,this.H,()=>{this.W.end(t)})})}Register(){return e(this,void 0,void 0,function*(){if(!this.X){this.emit("info",`Registering with the DBGp proxy on ${this.H}:${this.J} with key ${this.L}...`);var t=this.M?"1":"0",i=`proxyinit -k ${this.L} -p ${this.N} -m ${t}`;yield this.V(i,t=>{t.Success?(this.X=!0,this.emit("info","Registration was successful!")):this.emit("error",t.ErrorMessage)})}})}Unregister(){return e(this,void 0,void 0,function*(){if(this.X){this.emit("info",`Unregistring the client with key ${this.L} from DBGp proxy...`);var t=`proxystop -k ${this.L}`;yield this.V(t,t=>{t.Success?(this.X=!1,this.emit("info","Unregistred!")):this.emit("error",t.ErrorMessage)})}})}}exports.DbgpProxyHandler=Jt;class Lt{constructor(t,i){var s=Ht.decode(t,i),e=new Kt.DOMParser;this.Y=e.parseFromString(s,"application/xml")}get Success(){return"1"===this.Y.documentElement.getAttribute("success")}get IdeKey(){return this.Y.documentElement.getAttribute("idekey")}get Address(){return this.Y.documentElement.getAttribute("address")}get Port(){return this.Y.documentElement.getAttribute("port")}get Command(){return this.Y.documentElement.nodeName}get ErrorMessage(){return this.Y.getElementsByTagName("error")[0].getElementsByTagName("message")[0]}}