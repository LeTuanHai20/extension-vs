"use strict";var e=this&&this.t||function(r,t,e,n){return new(e||(e=Promise))(function(o,i){function u(r){try{a(n.next(r))}catch(r){i(r)}}function c(r){try{a(n.throw(r))}catch(r){i(r)}}function a(r){var t;r.done?o(r.value):(t=r.value,t instanceof e?t:new e(function(r){r(t)})).then(u,c)}a((n=n.apply(r,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const fr=require("https"),vr=require("url"),pr=require("./proxy");function Er(r,t,n,o,i){return e(this,void 0,void 0,function*(){t.appendLine("Downloading "+r+" ..."),t.appendLine("URL: "+o);try{return $r(r,o,t,n).then(r=>(t.appendLine("Download Successful."),r))}catch(e){if(!i)throw e;t.appendLine("Alternative URL: "+i);try{let o=yield $r(r,i,t,n);return t.appendLine("Download Successful."),o}catch(r){throw e}}})}function $r(r,t,n,o){return e(this,void 0,void 0,function*(){const e=vr.parse(t),i=o(),u=i.proxy,c=i.strictSSL,a={host:e.hostname,path:e.path,agent:pr.getProxyAgent(e,u,c),port:e.port,timeout:900,rejectUnauthorized:!yr(c)||c};let s=[];return new Promise((e,i)=>{let u=fr.request(a,u=>{if(301===u.statusCode||302===u.statusCode)return n.appendLine(`\nRedirect: ${u.headers.location}`),e($r(r,u.headers.location,n,o));if(200!=u.statusCode)return n.appendLine(`\nDownload failure: status code '${u.statusCode}'`),i(new Error(u.statusCode.toString()));let c=parseInt(u.headers["content-length"]),a=0,f=0,l=`Downloading (${Math.floor(c/1024)}kB):`;n.appendLine(l),u.on("data",r=>{a+=r.length,s.push(r);let t=Math.ceil(l.length*(a/c));for(;f<t;)n.append("."),f++}),u.on("end",()=>{e(Buffer.concat(s))}),u.on("error",r=>{i(new Error(`Failed to download from ${t}. Error Message: ${r.message} || 'NONE'}`))})});u.on("error",r=>{n.appendLine(`\nError: ${r.message}`),i(new Error(`Request error: ${r.message||"NONE"}`))}),u.end()})})}function yr(r){return!0===r||!1===r}exports.DownloadFile=Er;