"use strict";var e=this&&this.t||function(e,n,t,i){return new(t||(t=Promise))(function(o,r){function s(e){try{c(i.next(e))}catch(e){r(e)}}function u(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t(function(e){e(n)})).then(s,u)}c((i=i.apply(e,n||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const t=require("vscode"),h=require("./mainTest"),f=require("./debug/ConfigurationProvider"),g=require("vscode-languageclient"),w=require("os"),y=require("xmlhttprequest"),x=require("child_process"),b=require("./downloader/FileDownloader"),P=require("./downloader/NetworkSettings"),q=require("fs"),S=require("path"),T=require("./embeddedContentDocuments"),H=require("./embeddedPhar"),k=require("./utils"),D=require("./telemetry"),$=require("events"),O=require("./Resource");let E=new $.EventEmitter;const N="DEVSENSE.phptools-vscode";let L;const z="dotnet";let F,J,K,_="",j=0;function A(e){return O.GlobalResources.Get().GetString(__filename,e)}var I;function M(n){return e(this,void 0,void 0,function*(){exports.o=n,D.s();let e=JSON.parse(q.readFileSync(n.asAbsolutePath("package.json"),"utf8")).contributes.configuration.properties["phpTools.language"].enum;if(O.GlobalResources.InitGlobalResources(n.asAbsolutePath("locale"),e),(L=t.window.createOutputChannel("PHP")).appendLine("PHP Tools extension started."),n.subscriptions.push(t.commands.registerCommand("phptools.activate",()=>Je())),n.subscriptions.push(J=t.window.createStatusBarItem(t.StatusBarAlignment.Right,99)),n.subscriptions.push(K=t.window.createStatusBarItem(t.StatusBarAlignment.Left,0)),n.subscriptions.push(t.window.onDidChangeActiveTextEditor(e=>{"php"==e.document.languageId.toLowerCase()?J.show():J.hide()})),!G()){const e="mute.missingphp";if(!n.globalState.get(e)){const i=A("dontshowagain"),o=A("dismiss");t.window.showWarningMessage("The `php` command cannot be found. Please verify that PHP is installed, or change `php.executablePath` setting.",o,i).then(t=>{t==i&&n.globalState.update(e,!0)})}}E.on("event",()=>{C(),Y(),ne(n).then(e=>{F=e,n.subscriptions.push(F.start());const i=new f.PhpDebugConfigurationProvider(F);n.subscriptions.push(t.debug.registerDebugConfigurationProvider("php",i)),n.subscriptions.push(i),n.subscriptions.push(Z()),n.subscriptions.push(t.commands.registerCommand("phpTools.debug.startWithStopOnEntry",f.startDebuggingAndStopOnEntry)),n.subscriptions.push(H.initializeEmbeddedPharDocuments(F)),F.onReady().then(()=>{F.onNotification("devsense/loadStatus",e=>{j=(j+1)%2,K.tooltip="Processing workspace changes ...";let n=j?"$(circle-filled)":"$(circle-outline)";e.isLoadPending?(K.text=`${n} Processing ${e.pendingParse+e.pendingAnalysis} â€¦`,K.show()):e.pendingAnalysis>100?(K.text=n,K.show()):K.hide()})}),L.appendLine("PHP language server started.")});let e=(t.workspace.workspaceFolders||[])[0];e&&new h.UnitTests(n,e),E=new $.EventEmitter}),Le()})}function R(){F&&F.stop(),D.client.trackEvent({name:"extension unloaded"})}function C(){return e(this,void 0,void 0,function*(){let e=t.extensions.all,n=[N,"codingyu.laravel-goto-view","vscode.php-language-features","chinchiheather.vscode-margin-colours","aaron-bond.better-comments","phproberto.vscode-php-getters-setters","junstyle.php-cs-fixer","ikappas.phpcs","chrmarti.regex","johnbillion.vscode-wordpress-hooks","SonarSource.sonarlint-vscode","persoderlind.vscode-phpcbf","iolevel.peachpie-vscode","ecmel.vscode-html-css"],i=e.filter(e=>e&&e.packageJSON&&e.packageJSON.activationEvents&&e.packageJSON.activationEvents.indexOf("onLanguage:php")>=0&&n.indexOf(e.id)<0);if(exports.o.globalState.get("suppress.extensions.check")!=i.length&&0!=i.length){const e=A("extensions"),n=A("dontshowagain");let o;switch(o="Following extensions should be disabled since their features overlaps with PHP Tools: "+i.map(e=>e.id).join(", "),yield t.window.showErrorMessage(o,e,n)){case e:yield t.commands.executeCommand("workbench.view.extensions");break;case n:exports.o.globalState.update("suppress.extensions.check",i.length)}}})}function V(){let e=x.spawnSync(z,["--version"],{encoding:"utf8"});if(e.output){let n=e.output.join(""),t="osx"==B();return 0==n.indexOf("3.")&&!t||0==n.indexOf("5.")}return!1}function X(e,n=null){J.tooltip=e||"PHP executable",J.text=n||"7.4",J.show()}function G(){let e=ee(),n=x.spawnSync(e,["--version"],{encoding:"utf8"});if(n.output){var t=n.output.join(""),i=/^PHP\s([\d\.a-z\-]+)/g.exec(t);if(i&&i[1]){var o=/with Xdebug v([\d\.a-z\-]+)/.exec(t);return X(e,_=i[1]),D.client.trackEvent({name:"has php",properties:{"php-version":_,"xdebug-version":o?o[1]:"none"}}),L.appendLine(`Found PHP, version: ${_}, Xdebug: ${o?o[1]:"not loaded"}.`),!0}}return X(e),_="",D.client.trackEvent({name:"no php",properties:{}}),L.appendLine("Notice: PHP cannot be found."),!1}function U(e,n){let i=`${B()}-${Q()}-${W()}`,o=S.join(n,"Devsense.PHP.LanguageServer"),r=`https://devsenseblob.azureedge.net/phptools/vscode/${i}.zip`,s={name:"downloading runtime",url:r,resultCode:0,success:!1,duration:0};if(q.existsSync(S.join(n,"phptools-verify")))return Promise.resolve();{L.show(!0);let u=+new Date;return b.DownloadFile(`PHP Tools dependencies (${i})`,L,P.vscodeNetworkSettingsProvider(),r).then(t=>{q.writeFileSync(e,t);var r=require("extract-zip");return new Promise((t,o)=>{L.appendLine(`Installing package '${i}'`),r(e,{dir:n},function(e){e?o(e.message):t()})}).then(()=>{"win"!=B()&&q.chmodSync(o,365),q.unlink(e,e=>{}),s.success=!0,q.existsSync(o)||q.existsSync(o+".exe")?L.appendLine("Finished.\n"):L.appendLine("Download failed.\n")},e=>{s.success=!1,L.appendLine(e)})},e=>{s.success=!1;const n=A("download");t.window.showErrorMessage("The extension requires 'dotnet' runtime for full functionality.",n).then(e=>{e==n&&require("open")("https://www.microsoft.com/net/download")})}).then(()=>{s.duration=+new Date-u,D.client.trackRequest(s)})}}function W(){return t.extensions.getExtension(N).packageJSON.version}function B(){var e=process.platform;return"darwin"==e?"osx":"win32"==e?"win":"linux"==e?"linux":void 0}function Q(){return"win32"==process.platform&&"x86"==process.arch?"x86":"x64"}function Y(){let e=t.workspace.getConfiguration();e.update("php.suggest.basic",!1,t.ConfigurationTarget.Global),e.update("php.validate.enable",!1,t.ConfigurationTarget.Global);let n=e.get("emmet.excludeLanguages");-1==n.indexOf("php")&&e.update("emmet.excludeLanguages",n.concat(["php"]),t.ConfigurationTarget.Global)}function Z(){return t.workspace.onDidChangeConfiguration(e=>{let n=t.workspace.getConfiguration(),i={};e.affectsConfiguration("phpTools.language")&&(i["phpTools.language"]=n.get("phpTools.language")||t.env.language),e.affectsConfiguration("php.problems.exclude")&&(i["php.problems.exclude"]=n.get("php.problems.exclude")),e.affectsConfiguration("files.exclude")&&(i["files.exclude"]=n.get("files.exclude")),e.affectsConfiguration("php.format.codeStyle")&&(i["php.format.codeStyle"]=n.get("php.format.codeStyle")),e.affectsConfiguration("php.executablePath")&&(G(),i["php.version"]=_),e.affectsConfiguration("php.problems.workspaceAnalysis")&&(i["php.problems.workspaceAnalysis"]=n.get("php.problems.workspaceAnalysis")),0!=Object.keys(i).length&&F.sendNotification(g.DidChangeConfigurationNotification.type,{settings:i})})}function ee(e,n="php"){return e||t.workspace.getConfiguration().php.executablePath||n}function ne(e){return te(e).then(e=>{let n={run:{command:e.command,args:e.args},debug:{command:e.command,args:e.args.concat(["--debug"])}},i=T.initializeEmbeddedContentDocuments(()=>F),o=t.workspace.getConfiguration(),r={documentSelector:[{scheme:"file",language:"php"}],initializationOptions:{"files.associations":o.get("files.associations"),"files.exclude":o.get("files.exclude"),"php.problems.exclude":o.get("php.problems.exclude"),"phpTools.language":o.get("phpTools.language")||t.env.language,"php.format.codeStyle":o.get("php.format.codeStyle"),"php.problems.workspaceAnalysis":o.get("php.problems.workspaceAnalysis"),"php.version":_},synchronize:{fileEvents:[t.workspace.createFileSystemWatcher("**/*.php;**/*.phar")]},middleware:i.middleware};return new g.LanguageClient("PHP Language Server",n,r)})}function te(e){let n=e.asAbsolutePath("out/server/Devsense.PHP.LanguageServer");return V()?Promise.resolve({command:z,args:[n+".dll"]}):U(e.asAbsolutePath("out.zip"),e.asAbsolutePath("out/server")).then(()=>Promise.resolve({command:n,args:[]}))}!function(e){e[e.Missing=0]="Missing",e[e.Expired=1]="Expired",e[e.Valid=2]="Valid",e[e.Invalid=3]="Invalid"}(I||(I={})),exports.activate=M,exports.deactivate=R,exports.u=ee,exports.l=ne;let ie=[45,45,45,45,45,66,69,71,73,78,32,80,85,66,76,73,67,32,75,69,89,45,45,45,45,45,10,77,73,71,102,77,65,48,71,67,83,113,71,83,73,98,51,68,81,69,66,65,81,85,65,65,52,71,78,65,68,67,66,105,81,75,66,103,81,67,118,67,119,109,55,98,72,43,79,117,73,70,67,77,102,68,85,79,48,121,86,85,84,104,73,10,90,113,50,116,122,50,84,81,73,50,85,100,50,80,103,69,107,104,55,74,100,111,51,51,80,77,49,50,67,76,66,108,71,86,89,106,105,107,82,65,100,112,75,118,104,105,115,66,48,101,43,102,47,51,119,43,73,116,56,109,115,74,114,67,10,86,84,114,120,75,116,88,116,65,70,83,115,83,55,51,83,110,110,98,121,74,89,121,105,120,114,115,69,67,65,85,121,101,116,122,99,71,52,116,54,52,47,48,57,108,74,117,110,79,97,85,106,71,98,74,80,50,87,116,106,51,47,116,50,10,57,90,99,67,122,119,68,85,84,89,81,43,56,56,78,102,48,81,73,68,65,81,65,66,10,45,45,45,45,45,69,78,68,32,80,85,66,76,73,67,32,75,69,89,45,45,45,45,45];const oe=[89,111,117,114,32,99,111,112,121,32,111,102,32,80,72,80,32,84,111,111,108,115,32,105,115,32,110,111,116,32,97,99,116,105,118,97,116,101,100,46,32,80,108,101,97,115,101,32,101,110,116,101,114,32,121,111,117,114,32,108,105,99,101,110,115,101,32,107,101,121,46],re=[89,111,117,114,32,99,117,114,114,101,110,116,32,108,105,99,101,110,115,101,32,104,97,115,32,101,120,112,105,114,101,100,46,32,80,108,101,97,115,101,32,101,110,116,101,114,32,97,32,110,101,119,32,108,105,99,101,110,115,101,32,107,101,121,46],se=[73,32,104,97,118,101,32,116,104,101,32,108,105,99,101,110,115,101,32,107,101,121],ue=[71,101,116,32,116,114,105,97,108],ce=[89,111,117,114,32,101,45,109,97,105,108],le=[80,108,101,97,115,101,32,101,110,116,101,114,32,121,111,117,114,32,101,45,109,97,105,108,32,97,100,100,114,101,115,115,46,32,89,111,117,32,119,105,108,108,32,114,101,99,101,105,118,101,32,116,104,101,32,116,114,105,97,108,32,108,105,99,101,110,115,101,32,107,101,121,32,105,110,32,97,32,102,101,119,32,109,105,110,117,116,101,115,46,32,70,111,114,32,109,111,114,101,32,105,110,102,111,114,109,97,116,105,111,110,32,118,105,115,105,116,32,119,119,119,46,100,101,118,115,101,110,115,101,46,99,111,109],ae=[63,109,101,116,104,111,100,61,116,114,105,97,108,95,118,115,99,111,100,101],de=[38,109,97,105,108,61],pe=[69,110,116,101,114,101,100,32,101,45,109,97,105,108,32,105,115,32,110,111,116,32,118,97,108,105,100],he=[77,111,114,101,32,105,110,102,111,114,109,97,116,105,111,110],fe=[80,117,114,99,104,97,115,101],ve=[80,108,101,97,115,101,32,101,110,116,101,114,32,121,111,117,114,32,108,105,99,101,110,115,101,32,107,101,121,46,32,73,116,32,119,105,108,108,32,98,101,32,97,99,116,105,118,97,116,101,100,32,111,110,108,105,110,101,46,32,70,111,114,32,109,111,114,101,32,105,110,102,111,114,109,97,116,105,111,110,32,118,105,115,105,116,32,119,119,119,46,100,101,118,115,101,110,115,101,46,99,111,109],ge=[76,105,99,101,110,115,101,32,75,101,121],me=[104,116,116,112,115,58,47,47,119,119,119,46,100,101,118,115,101,110,115,101,46,99,111,109,47,112,117,114,99,104,97,115,101,63,102,114,111,109,61,118,115,99,111,100,101],we=[76,105,99,101,110,115,101,32,105,110,118,97,108,105,100,32,111,114,32,101,120,112,105,114,101,100,46],ye=[67,111,110,110,101,99,116,105,111,110,32,116,111,32,97,99,116,105,118,97,116,105,111,110,32,115,101,114,118,101,114,32,116,105,109,101,111,117,116,101,100,46],xe=[65,99,116,105,118,97,116,105,111,110,32,115,101,114,118,101,114,32,99,97,110,110,111,116,32,98,101,32,114,101,97,99,104,101,100,46],be=[65,99,116,105,118,97,116,105,111,110,32,101,114,114,111,114,46],Pe=[65,99,116,105,118,97,116,105,111,110,32,115,101,114,118,101,114,32,105,115,32,117,110,97,118,97,105,108,97,98,108,101,32,97,116,32,116,104,105,115,32,116,105,109,101,46],qe=[65,99,116,105,118,97,116,105,111,110,32,115,101,114,118,101,114,32,105,110,116,101,114,110,97,108,32,101,114,114,111,114,46],Se=[69,110,116,101,114,101,100,32,108,105,99,101,110,115,101,32,107,101,121,32,105,115,32,110,111,116,32,118,97,108,105,100,46],Te=[104,116,116,112,115,58,47,47,97,112,105,46,100,101,118,115,101,110,115,101,46,99,111,109,47,108,105,99,101,110,115,101,47],He=[104,116,116,112,115,58,47,47,119,119,119,46,100,101,118,115,101,110,115,101,46,99,111,109,47,112,117,114,99,104,97,115,101,47,108,105,99,101,110,115,101],ke=[65,99,116,105,118,97,116,105,111,110,32,115,117,99,99,101,101,100,101,100,44,32,116,104,97,110,107,32,121,111,117,32,102,111,114,32,117,115,105,110,103,32,80,72,80,32,84,111,111,108,115,33],De=[63,109,101,116,104,111,100,61,97,99,116,105,118,97,116,101,95,118,115,99,111,100,101],$e=[38,109,97,99,104,105,110,101,95,105,100,61],Oe=[38,107,101,121,61],Ee=[110,111,100,101,45,114,115,97],Ne=[112,104,112,84,111,111,108,115,46,108,105,99,101,110,115,101];function Le(){return e(this,void 0,void 0,function*(){(yield Me())==I.Valid?E.emit("event"):yield ze()})}function ze(){return e(this,void 0,void 0,function*(){let e,n=yield Ae();e=n&&(yield Ie(n))?[A("expired"),A("enterKey"),A("purchase")]:[A("activationMessage"),A("enterKey"),A("requestTrial"),A("info")],yield Fe(yield t.window.showInformationMessage.apply("",e))})}function Fe(n){return e(this,void 0,void 0,function*(){n==A("info")||n==A("purchase")?(je(),yield ze()):n==A("requestTrial")?yield Ke():n==A("enterKey")&&(yield Je())})}function Je(){return e(this,void 0,void 0,function*(){let e=yield t.window.showInputBox({prompt:A("promptText"),placeHolder:A("placeHolder"),ignoreFocusOut:!0});if(e){let n=void 0;if(e.length>32)try{JSON.parse(e).signature&&(n=e)}catch(e){n=void 0}n||(n=yield Ce(k.p(De),k.p(Oe),new(require(k.p(Ee)))(k.p(ie)).encrypt(e,"base64").replace(/\+/g,"-").replace(/\//g,"|").replace(/=/g,"_"))),n&&(yield Ve(n))}else ze()})}function Ke(){return e(this,void 0,void 0,function*(){let e=yield t.window.showInputBox({prompt:A("trialPrompt"),placeHolder:A("trialMail"),ignoreFocusOut:!0,validateInput:e=>/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(e)?null:A("invalidMail")});if(e){let n=yield Ce(k.p(ae),k.p(de),e);n&&(yield _e(n))}else yield ze()})}function _e(n){return e(this,void 0,void 0,function*(){try{let e=JSON.parse(n);D.client.trackEvent({name:"trial requested"}),(yield t.window.showInformationMessage(e.message,A("enterKey")))?yield Je():yield ze()}catch(e){t.window.showErrorMessage("Invalid Response")}})}function je(){return e(this,void 0,void 0,function*(){require("open")(k.p(me))})}function Ae(){return e(this,void 0,void 0,function*(){try{return JSON.parse(exports.o.globalState.get(k.p(Ne)+"."+w.userInfo().username)||exports.o.globalState.get(k.p(Ne))||t.workspace.getConfiguration().get(k.p(Ne)))}catch(e){return}})}function Ie(n){return e(this,void 0,void 0,function*(){return new Date>new Date(n.expiration)})}function Me(){return e(this,void 0,void 0,function*(){let e=yield Ae();if(e){var n=require(k.p(k.h))(w.userInfo().username)+"#"+e.license+"#"+e.expiration;return new(require(k.p(Ee)))(k.p(ie)).verify(n,e.signature,"utf8","base64")?(yield Ie(e))?I.Expired:I.Valid:I.Invalid}return I.Missing})}function Re(n,i){return e(this,void 0,void 0,function*(){const e=k.p(He)+i;L.appendLine(n),i&&(L.appendLine("Notice: If you have issues accessing our server, open following URL in a web browser:"),L.appendLine(e));const o=i?"Activate offline":void 0;let r=yield t.window.showErrorMessage(n,"Retry",o);"Retry"==r?Je():r==o&&o&&require("open")(e)})}function Ce(n,t,i){return e(this,void 0,void 0,function*(){if(!i)return;let e=n+k.p($e)+require(k.p(k.h))(w.userInfo().username)+t+i,o=k.p(Te)+e,r=new y.XMLHttpRequest;var s=+new Date;return r.open("GET",o,!0),new Promise(t=>{r.onreadystatechange=function(){if(4==this.readyState){var i=+new Date-s;if(D.client.trackRequest({name:n,url:o,duration:i,resultCode:this.status,success:200==this.status}),200==this.status)t(this.responseText);else{var r;if(r=404==this.status||401==this.status?A("invalidLicenseKey"):403==this.status?A("accessDenied"):500==this.status?A("internalError"):0==this.status?A("connectionError"):A("unknownError"),this.responseText)try{let e=JSON.parse(this.responseText);e.message&&(r=e.message)}catch(e){}Re(r,500==this.status||0==this.status?e:void 0),t(void 0)}}},r.ontimeout=(()=>{Re(A("serverTimeout"),e),t(void 0)}),r.timeout=5e3,r.send()})})}function Ve(n){return e(this,void 0,void 0,function*(){try{JSON.parse(n),exports.o.globalState.update(k.p(Ne)+"."+w.userInfo().username,n),L.appendLine("The license has been stored."),(yield Me())==I.Valid?(t.window.showInformationMessage(A("activationSucceeded")),D.client.trackEvent({name:"extension activated"}),E.emit("event")):D.client.trackEvent({name:"extension activation error"})}catch(e){L.appendLine("Error decoding given license."),t.window.showErrorMessage(A("invalidLicenseKey")),D.client.trackException({exception:e}),ze()}})}