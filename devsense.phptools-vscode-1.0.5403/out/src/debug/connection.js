"use strict";var e=this&&this.t||function(t,e,s,n){return new(s||(s=Promise))(function(i,r){function o(t){try{c(n.next(t))}catch(t){r(t)}}function h(t){try{c(n.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s(function(t){t(e)})).then(o,h)}c((n=n.apply(t,e||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const dt=require("iconv-lite"),mt=require("./debugConnection"),ft="iso-8859-1";class vt{constructor(t,e){const s=t.documentElement;this.fileUri=s.getAttribute("fileuri"),this.language=s.getAttribute("language"),this.protocolVersion=s.getAttribute("protocol_version"),this.ideKey=s.getAttribute("idekey"),this.engineVersion=s.getElementsByTagName("engine")[0].getAttribute("version"),this.connection=e}}exports.InitPacket=vt;class xt extends Error{constructor(t,e){super(t),this.code=e,this.message=t,this.name="XdebugError"}}exports.XdebugError=xt;class yt{constructor(t,e){const s=t.documentElement;if(s.firstChild&&"error"===s.firstChild.nodeName){const t=s.firstChild,e=parseInt(t.getAttribute("code")),n=t.textContent;throw new xt(n,e)}this.transactionId=parseInt(s.getAttribute("transaction_id")),this.command=s.getAttribute("command"),this.connection=e}}exports.Response=yt;class wt extends yt{constructor(t,e){super(t,e);const s=t.documentElement;if(this.status=s.getAttribute("status"),this.reason=s.getAttribute("reason"),s.hasChildNodes()){const t=s.firstChild;t.hasAttribute("exception")&&(this.exception={name:t.getAttribute("exception"),message:t.textContent},t.hasAttribute("code")&&(this.exception.code=parseInt(t.getAttribute("code")))),t.hasAttribute("filename")&&(this.fileUri=t.getAttribute("filename")),t.hasAttribute("lineno")&&(this.line=parseInt(t.getAttribute("lineno")))}}}exports.StatusResponse=wt;class $t{constructor(){if("object"==typeof arguments[0]){const t=arguments[0];this.connection=arguments[1],this.type=t.getAttribute("type"),this.id=parseInt(t.getAttribute("id")),this.state=t.getAttribute("state")}else this.type=arguments[0]}static fromXml(t,e){switch(t.getAttribute("type")){case"exception":return new bt(t,e);case"line":return new Ct(t,e);case"conditional":return new It(t,e);case"call":return new _t(t,e);default:throw new Error(`Invalid type ${t.getAttribute("type")}`)}}remove(){return this.connection.sendBreakpointRemoveCommand(this)}}exports.Breakpoint=$t;class Ct extends $t{constructor(){if("object"==typeof arguments[0]){const t=arguments[0];super(t,arguments[1]),this.line=parseInt(t.getAttribute("lineno")),this.fileUri=t.getAttribute("filename")}else super("line"),this.fileUri=arguments[0],this.line=arguments[1],this.logMessage=arguments[2]}}exports.LineBreakpoint=Ct;class _t extends $t{constructor(){if("object"==typeof arguments[0]){const t=arguments[0];super(t,arguments[1]),this.fn=t.getAttribute("function"),this.expression=t.getAttribute("expression")}else super("call"),this.fn=arguments[0],this.expression=arguments[1]}}exports.CallBreakpoint=_t;class bt extends $t{constructor(){if("object"==typeof arguments[0]){const t=arguments[0];super(t,arguments[1]),this.exception=t.getAttribute("exception")}else super("exception"),this.exception=arguments[0]}}exports.ExceptionBreakpoint=bt;class It extends $t{constructor(){if("object"==typeof arguments[0]){const t=arguments[0];super(t,arguments[1]),this.expression=t.getAttribute("expression")}else super("conditional"),this.expression=arguments[0],this.fileUri=arguments[1],this.line=arguments[2],this.logMessage=arguments[3]}}exports.ConditionalBreakpoint=It;class St extends yt{constructor(t,e){super(t,e),this.breakpointId=parseInt(t.documentElement.getAttribute("id"))}}exports.BreakpointSetResponse=St;class Et extends yt{constructor(t,e){super(t,e),this.breakpoints=Array.from(t.documentElement.childNodes).map(t=>$t.fromXml(t,e))}}exports.BreakpointListResponse=Et;class Pt{constructor(t,e){this.name=t.getAttribute("where"),this.fileUri=t.getAttribute("filename"),this.type=t.getAttribute("type"),this.line=parseInt(t.getAttribute("lineno")),this.level=parseInt(t.getAttribute("level")),this.connection=e}getContexts(){return e(this,void 0,void 0,function*(){return(yield this.connection.sendContextNamesCommand(this)).contexts})}}exports.StackFrame=Pt;class kt extends yt{constructor(t,e){super(t,e),this.stack=Array.from(t.documentElement.childNodes).map(t=>new Pt(t,e))}}exports.StackGetResponse=kt;class jt extends yt{constructor(t,e){super(t,e),this.source=new Buffer(t.documentElement.textContent,"base64").toString()}}exports.SourceResponse=jt;class At{constructor(t,e){this.id=parseInt(t.getAttribute("id")),this.name=t.getAttribute("name"),this.stackFrame=e}getProperties(){return e(this,void 0,void 0,function*(){return(yield this.stackFrame.connection.sendContextGetCommand(this)).properties})}}exports.Context=At;class Ft extends yt{constructor(t,e){super(t,e.connection),this.contexts=Array.from(t.documentElement.childNodes).map(t=>new At(t,e))}}exports.ContextNamesResponse=Ft;class Bt{constructor(t){if(t.hasAttribute("name")&&(this.name=t.getAttribute("name")),this.type=t.getAttribute("type"),t.hasAttribute("classname")&&(this.class=t.getAttribute("classname")),this.hasChildren=!!parseInt(t.getAttribute("children")),this.hasChildren)this.numberOfChildren=parseInt(t.getAttribute("numchildren"));else{const e=t.getAttribute("encoding");this.value=e?dt.encode(t.textContent,e)+"":t.textContent}this.size=parseInt(t.getAttribute("size"))}}exports.BaseProperty=Bt;class qt extends Bt{constructor(t,e,s){super(t),this.fullName=t.getAttribute("fullname"),this.frame=e,this.contextId=s,this.hasChildren&&(this.children=Array.from(t.childNodes).map(t=>new qt(t,e,s)))}getChildren(t=-1){return e(this,void 0,void 0,function*(){if(!this.hasChildren)throw new Error("This property has no children");return(yield this.frame.connection.sendPropertyGetCommand(this.fullName,this.frame,this.contextId,t)).result.children})}ensureCompleteString(){return e(this,void 0,void 0,function*(){"string"==this.type&&(this.size<=this.value.length||(this.value=(yield this.frame.connection.SendPropertyValueCommand(this.fullName,this.size,this.frame,this.contextId)).result.value))})}}exports.Property=qt;class Gt extends yt{constructor(t,e){super(t,e.stackFrame.connection),this.properties=Array.from(t.documentElement.childNodes).map(t=>new qt(t,e.stackFrame,e.id))}}exports.ContextGetResponse=Gt;class Ot extends yt{constructor(t,e,s){super(t,e.connection),t.documentElement.hasChildNodes()&&(this.result=new qt(t.documentElement.firstChild,e,s))}}exports.PropertyGetResponse=Ot;class Dt extends yt{constructor(t,e,s){super(t,e.connection),this.result=new qt(t.documentElement,e,s)}}exports.PropertyValueResponse=Dt;class Mt extends yt{constructor(t,e,s){super(t,e.connection),this.success="1"==t.documentElement.getAttribute("success")}}exports.PropertySetResponse=Mt;class Rt extends Bt{constructor(t){super(t),this.hasChildren&&(this.children=Array.from(t.childNodes).map(t=>new Rt(t)))}}exports.EvalResultProperty=Rt;class Tt extends yt{constructor(t,e){super(t,e),t.documentElement.hasChildNodes()&&(this.result=new Rt(t.documentElement.firstChild))}}exports.EvalResponse=Tt;class Xt extends yt{constructor(t,e){super(t,e),this.feature=t.documentElement.getAttribute("feature")}}exports.FeatureSetResponse=Xt;class zt extends mt.DbgpConnection{constructor(t){super(t),this.$=1,this.C=new Map,this._=[],this.I=!1,this.id=zt.S++,this.timeEstablished=new Date,this.k=new Promise((t,e)=>{this.j=t,this.A=e}),this.on("message",t=>{if("init"===t.documentElement.nodeName)this.j(new vt(t,this));else{const e=parseInt(t.documentElement.getAttribute("transaction_id"));if(this.C.has(e)){const s=this.C.get(e);this.C.delete(e),this.I=!1,s.resolveFn(t)}if(this._.length>0){const t=this._.shift();this.F(t).catch(t.rejectFn)}}})}get isPendingExecuteCommand(){return this.I}waitForInitPacket(){return this.k}B(t,e,s){return new Promise((n,i)=>{this.G({name:t,args:e,data:s,resolveFn:n,rejectFn:i,isExecuteCommand:!1})})}O(t,e,s){return new Promise((n,i)=>{this.G({name:t,args:e,data:s,resolveFn:n,rejectFn:i,isExecuteCommand:!0})})}G(t){0===this._.length&&0===this.C.size?this.F(t):this._.push(t)}F(t){return e(this,void 0,void 0,function*(){const e=this.$++;let s=t.name+" -i "+e;t.args&&(s+=" "+t.args),t.data&&(s+=" -- "+new Buffer(t.data).toString("base64")),s+="\0";const n=dt.encode(s,ft);this.C.set(e,t),this.I=t.isExecuteCommand,this.I&&this.emit("before-execute-command"),yield this.write(n)})}close(){return this._=[],this.A(new Error("connection closed")),super.close()}sendStatusCommand(){return e(this,void 0,void 0,function*(){return new wt(yield this.B("status"),this)})}sendFeatureGetCommand(t){return e(this,void 0,void 0,function*(){return yield this.B("feature_get","-n feature")})}sendFeatureSetCommand(t,s){return e(this,void 0,void 0,function*(){return new Xt(yield this.B("feature_set",`-n ${t} -v ${s}`),this)})}sendBreakpointSetCommand(t){return e(this,void 0,void 0,function*(){let e,s=`-t ${t.type}`;return t instanceof Ct?s+=` -f ${t.fileUri} -n ${t.line}`:t instanceof bt?s+=` -x ${t.exception}`:t instanceof It?(s+=` -f ${t.fileUri}`,"number"==typeof t.line&&(s+=` -n ${t.line}`),e=t.expression):t instanceof _t&&(s+=` -m ${t.fn}`,e=t.expression),new St(yield this.B("breakpoint_set",s,e),this)})}sendBreakpointListCommand(){return e(this,void 0,void 0,function*(){return new Et(yield this.B("breakpoint_list"),this)})}sendBreakpointRemoveCommand(t){return e(this,void 0,void 0,function*(){return new yt(yield this.B("breakpoint_remove",`-d ${t.id}`),this)})}sendStepCommand(t){return e(this,void 0,void 0,function*(){if(-1!=["step_into","step_over","step_out"].indexOf(t))return new wt(yield this.O(t),this);throw new Error(`The Command '${t}' is not supported.`)})}sendRunCommand(){return e(this,void 0,void 0,function*(){return new wt(yield this.O("run"),this)})}sendStepIntoCommand(){return e(this,void 0,void 0,function*(){return new wt(yield this.O("step_into"),this)})}sendStepOverCommand(){return e(this,void 0,void 0,function*(){return new wt(yield this.O("step_over"),this)})}sendStepOutCommand(){return e(this,void 0,void 0,function*(){return new wt(yield this.O("step_out"),this)})}sendStopCommand(){return e(this,void 0,void 0,function*(){return new wt(yield this.B("stop"),this)})}sendStackGetCommand(){return e(this,void 0,void 0,function*(){return new kt(yield this.B("stack_get"),this)})}sendSourceCommand(t){return e(this,void 0,void 0,function*(){return new jt(yield this.B("source",`-f ${t}`),this)})}sendContextNamesCommand(t){return e(this,void 0,void 0,function*(){return new Ft(yield this.B("context_names",`-d ${t.level}`),t)})}sendContextGetCommand(t){return e(this,void 0,void 0,function*(){return new Gt(yield this.B("context_get",`-d ${t.stackFrame.level} -c ${t.id}`),t)})}simplePropertyGetCommand(t,s){return e(this,void 0,void 0,function*(){var e=`-n ${this.DoubleQuoteAndEscapeString(t)}`;return e+=` -c ${s}`,new Ot(yield this.B("property_get",e),null,s)})}sendPropertyGetCommand(t,s,n,i=-1){return e(this,void 0,void 0,function*(){var e=`-n ${this.DoubleQuoteAndEscapeString(t)}`;return-1!=i&&(e+=` -p ${i}`),1!=n&&(e+=` -d ${s.level}`),e+=` -c ${n}`,new Ot(yield this.B("property_get",e),s,n)})}sendEvalCommand(t){return e(this,void 0,void 0,function*(){return new Tt(yield this.B("eval",void 0,t),this)})}SendPropertySetCommand(t,s,n,i){return e(this,void 0,void 0,function*(){const e=this.DoubleQuoteAndEscapeString(t);var r=new Buffer(s).toString("base64");if(1==i)var o=`-c ${i} -n ${e} -- {${r}}`;else o=`-d ${n.level} -c ${i} -n ${e} -- {${r}}`;return new Mt(yield this.B("property_set",o),n,i)})}SendPropertyValueCommand(t,s,n,i){return e(this,void 0,void 0,function*(){const e=this.DoubleQuoteAndEscapeString(t);if(1==i)var r=`-c ${i} -n ${e} -m ${s}`;else r=`-d ${n.level} -c ${i} -n ${e} -m ${s}`;return new Dt(yield this.B("property_value",r),n,i)})}DoubleQuoteAndEscapeString(t){return'"'+t.replace(/("|\\)/g,"\\$1")+'"'}}exports.Connection=zt,zt.S=1;