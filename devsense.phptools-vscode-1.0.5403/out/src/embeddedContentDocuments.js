"use strict";var e=this&&this.t||function(e,r,t,n){return new(t||(t=Promise))(function(i,o){function u(e){try{d(n.next(e))}catch(e){o(e)}}function c(e){try{d(n.throw(e))}catch(e){o(e)}}function d(e){var r;e.done?i(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(u,c)}d((n=n.apply(e,r||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const r=require("vscode"),t=require("vscode"),n=require("./embeddedContentUri"),i=require("util"),o="documentLanguageRanges";function u(o){let u=[];const c={};u.push(t.workspace.onDidCloseTextDocument(e=>{delete c[e.uri.toString()],delete c[n.getEmbeddedContentUri(e.uri.toString(!0)).toString()]}));const d=new class{constructor(){this.onDidChangeEmitter=new r.EventEmitter,this.onDidChange=this.onDidChangeEmitter.event}provideTextDocumentContent(e){if(!n.isEmbeddedContentUri(e))return"";var r=t.Uri.parse(n.getHostDocumentUri(e));const i=t.workspace.textDocuments.find(e=>e.uri.toString(!0)==r.toString(!0));return i?(c[e.toString()]=i.version,i.getText()):(delete c[e.toString()],"")}};function f(e,r){return o().sendRequest("devsense/resolveToken",{textDocument:{uri:e},position:r}).then(e=>Promise.resolve(14==e.Category),()=>Promise.resolve(!0))}function a(e,r,t){return t?t.line?f(e.uri.toString(),t):f(e.uri.toString(),t.start):Promise.resolve(!1)}function l(e,r){return d.onDidChangeEmitter.fire(e),t.workspace.openTextDocument(e).then(e=>e,e=>{t.window.showErrorMessage(e)})}function P(e,r,t,i,o,u,c){let d=t();return s(d)||(d=Promise.resolve(d)),d.then(t=>!i(t)||c.isCancellationRequested?t:a(e,e.version,r).then(r=>!r||c.isCancellationRequested?u:function(e,r){return l(n.getEmbeddedContentUri(e.uri.toString(!0)),e.version).then(e=>e?r(e):void 0)}(e,o)))}return u.push(t.workspace.registerTextDocumentContentProvider(n.i,d)),{middleware:{handleDiagnostics:(e,n,i)=>{for(let e=0;e<n.length;e++){var o=n[e].code;"PHP7001"==o||"PHP0421"==o?(n[e].tags=[t.DiagnosticTag.Unnecessary],n[e].severity=r.DiagnosticSeverity.Hint):"PHP6406"!=o&&"PHP6403"!=o&&"PHP6405"!=o||(n[e].tags=[2])}i(e,n)},provideOnTypeFormattingEdits:(t,n,i,o,u,c)=>e(this,void 0,void 0,function*(){let e=yield c(t,n,i,o,u);if("*"==i&&1==e.length){let t=e[0];r.window.activeTextEditor.insertSnippet(new r.SnippetString(t.newText),t.range),e=void 0}return e}),provideCompletionItem:(e,r,n,i,o)=>P(e,r,()=>o(e,r,n,i),v,e=>"$"===n.triggerCharacter||">"===n.triggerCharacter||"\\"===n.triggerCharacter||":"===n.triggerCharacter?new t.CompletionList([],!1):t.commands.executeCommand("vscode.executeCompletionItemProvider",e.uri,r,n.triggerCharacter),new t.CompletionList([],!1),i),provideSignatureHelp:(e,r,n,i)=>P(e,r,()=>i(e,r,n),e=>!e,e=>t.commands.executeCommand("vscode.executeSignatureHelpProvider",e.uri,r),void 0,n),provideDefinition:(r,i,u,c)=>P(r,i,()=>c(r,i,u),e=>!e||Array.isArray(e)&&0==e.length,r=>e(this,void 0,void 0,function*(){const e=yield t.commands.executeCommand("vscode.executeDefinitionProvider",r.uri,i);return e?Array.isArray(e)?(e.forEach(e=>{n.isEmbeddedContentUri(e.uri)&&(e.uri=o().protocol2CodeConverter.asUri(n.getHostDocumentUri(e.uri)))}),e):(n.isEmbeddedContentUri(e.uri)&&(e.uri=o().protocol2CodeConverter.asUri(n.getHostDocumentUri(e.uri))),e):e}),[],u),provideReferences:(e,r,i,u,c)=>P(e,r,()=>c(e,r,i,u),e=>!e||Array.isArray(e)&&e.length<1,e=>t.commands.executeCommand("vscode.executeReferenceProvider",e.uri,r).then(e=>(e.forEach(e=>{n.isEmbeddedContentUri(e.uri)&&(e.uri=o().protocol2CodeConverter.asUri(n.getHostDocumentUri(e.uri)))}),e)),[],u),provideDocumentLinks:(e,r,i)=>a(e,e.version).then(i=>{if(!i||r.isCancellationRequested)return[];return l(n.getEmbeddedContentUri(e.uri.toString(!0)),e.version).then(e=>e?t.commands.executeCommand("vscode.executeLinkProvider",e.uri):[])}),provideDocumentHighlights:(e,r,n,i)=>P(e,r,()=>i(e,r,n),e=>!e||Array.isArray(e)&&e.length<1,e=>t.commands.executeCommand("vscode.executeDocumentHighlights",e.uri,r),[],n),provideHover:(e,r,n,o)=>P(e,r,()=>o(e,r,n),e=>!e||!e.contents||Array.isArray(e.contents)&&e.contents.length<1,e=>t.commands.executeCommand("vscode.executeHoverProvider",e.uri,r).then(e=>{var r=e.shift();if(!i.isNullOrUndefined(r)){var n=r.contents.map(e=>e.value);return new t.Hover(n,r.range)}}),void 0,n),provideDocumentRangeFormattingEdits:(e,r,t,n,i)=>i(e,r,t,n)},dispose:t.Disposable.from(...u).dispose}}function c(e,t,n){if(!n||0==n.length)return t;let i=t;for(var o of n){if(" "==o.newText&&"<?"==e.getText(new r.Range(o.range.start.translate(void 0,-2),o.range.start)))continue;let n=0,c=t.length;for(var u;n<c;){let e=Math.floor((n+c)/2);if((u=t[e]).range.end.compareTo(o.range.start)<0)n=e+1;else{if(!(u.range.start.compareTo(o.range.end)>0))break;c=e}}n>=c&&i.push(o)}return i}function d(e){return void 0!==e}function s(e){return e&&void 0!==e.then}function v(e){return!e||Array.isArray(e)&&e.length<1||!e.items||e.items.length<1}exports.initializeEmbeddedContentDocuments=u;