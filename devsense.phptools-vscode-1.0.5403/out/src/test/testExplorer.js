"use strict";var e=this&&this.t||function(t,e,i,s){return new(i||(i=Promise))(function(r,o){function n(t){try{c(s.next(t))}catch(t){o(t)}}function h(t){try{c(s.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(n,h)}c((s=s.apply(t,e||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const r=require("vscode"),ci=require("./tree/testCollection"),di=require("./iconPaths"),fi=require("./treeEventDebouncer"),vi=require("./testScheduler"),ai=require("./decorator"),i=require("./util");class wi{constructor(t){this.treeDataChanged=new r.EventEmitter,this.codeLensesChanged=new r.EventEmitter,this.collections=[],this.scheduler=new vi.TestScheduler,this.iconPaths=new di.IconPaths(t),this.decorator=new ai.Decorator(t,this),this.treeEvents=new fi.TreeEventDebouncer(this.collections,this.treeDataChanged),this.outputChannel=r.window.createOutputChannel("Test Explorer"),t.subscriptions.push(this.outputChannel),this.onDidChangeTreeData=this.treeDataChanged.event,this.onDidChangeCodeLenses=this.codeLensesChanged.event}registerAdapter(t){this.collections.push(new ci.TestCollection(t,this))}unregisterAdapter(t){var e=this.collections.findIndex(e=>e.adapter===t);e>=0&&(this.collections[e].dispose(),this.collections.splice(e,1))}getTreeItem(t){return t.getTreeItem()}getChildren(t){if(t)return t.children;{const t=this.collections.filter(t=>void 0!==t.suite);return 0===t.length?[]:1===t.length?t[0].suite.children:t.map(t=>t.suite)}}reload(t){if(t)this.scheduler.scheduleReload(t.collection,!1);else for(const t of this.collections)this.scheduler.scheduleReload(t,!1)}run(t){return e(this,void 0,void 0,function*(){if(t){const e=yield this.pickNode(t);e&&this.scheduler.scheduleTestRun(e)}else for(const t of this.collections)t.suite&&this.scheduler.scheduleTestRun(t.suite)})}debug(t){return e(this,void 0,void 0,function*(){yield this.scheduler.cancel();const e=yield this.pickNode(t);if(e)try{yield e.collection.adapter.debug(e.info)}catch(t){return void r.window.showErrorMessage(`Error while debugging test: ${t}`)}})}cancel(){this.scheduler.cancel()}selected(t){t&&(t.log?(this.outputChannel.clear(),this.outputChannel.append(t.log),this.outputChannel.show(!0)):this.outputChannel.hide())}showSource(t){return e(this,void 0,void 0,function*(){const e=t.info.file;if(e){const s=yield r.workspace.openTextDocument(e);let o=t.info.line;void 0===o&&(o=i.findLineContaining(t.info.label,s.getText()),t.info.line=o);const n=void 0!==o?{selection:new r.Range(o,0,o,0)}:void 0;yield r.window.showTextDocument(s,n)}})}setAutorun(t){if(t)t.collection.setAutorun(t);else for(const t of this.collections)t.setAutorun(t.suite)}clearAutorun(t){if(t)t.collection.setAutorun(void 0);else for(const t of this.collections)t.setAutorun(void 0)}retireState(t){if(t&&t.collection)t.collection.retireState(t);else for(const t of this.collections)t.retireState()}resetState(t){if(t&&t.collection)t.collection.resetState(t);else for(const t of this.collections)t.resetState()}provideCodeLenses(t,e){const i=t.uri.fsPath,s=this.collections.map(t=>t.getCodeLenses(i));return[].concat(...s)}pickNode(t){return e(this,void 0,void 0,function*(){let e=t.filter(t=>void 0!=t&&null!=t);if(1===e.length)return t[0];if(e.length>1){const t=e.map(t=>t.info.label),i=yield r.window.showQuickPick(t);return e.find(t=>t.info.label===i)}})}}exports.TestExplorer=wi;