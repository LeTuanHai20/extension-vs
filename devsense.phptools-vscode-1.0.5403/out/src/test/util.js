"use strict";var e=this&&this.t||function(e,t,n,i){return new(n||(n=Promise))(function(r,s){function u(e){try{o(i.next(e))}catch(e){s(e)}}function l(e){try{o(i.throw(e))}catch(e){s(e)}}function o(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(u,l)}o((i=i.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const r=require("vscode"),Ze=require("path"),Yt=require("fs"),en=require("escape-string-regexp"),tn=require("recursive-readdir-sync"),q=require("fs"),S=require("path");function*nn(e){if("suite"===e.info.type)for(const t of e.children)yield*nn(t);else yield e}function rn(e,t){return tn(e).filter(e=>e.toLowerCase().replace(/\\/g,"/").endsWith(t))}function sn(e){return Ze.join(e,"phpunit.xml")}function un(){return e(this,void 0,void 0,function*(){let e=yield r.workspace.findFiles("{phpunit.xml,phpunit.xml.dist}","{.vscode/**}",10);if(0==e.length&&(e=yield r.workspace.findFiles("{**/phpunit.xml,**/phpunit.xml.dist}","{**/vendor/**,.vscode/**,.git}",64)),0!=e.length){var t=[];for(let n=0;n<e.length;n++){let i=e[n].fsPath;i.endsWith(".dist")&&e.findIndex((e,t)=>e.fsPath==i.substr(0,i.length-".dist".length))>=0||t.push(e[n])}e=t}return e})}function ln(e){return null!=e&&0!=e.length?e[0]:null}function on(e){return null!=e&&0!=e.length?e[e.length-1]:null}function pn(e,t,n,i,r){let s=new RegExp("testSuiteStarted name='([^']*)' (locationHint='php_qn://((.:)?[^:]*))?"),u=new RegExp("testStarted name='([^']*)' (locationHint='php_qn://((.:)?[^:]*))?"),l=new RegExp("testFailed name='([^']*)' (message='([^']*)')?"),o=new RegExp("testIgnored name='([^']*)' (message='([^']*)')?"),p=new RegExp("testFinished name='([^']*)'"),d=new RegExp("testSuiteFinished name='([^']*)'"),f=e.split("##teamcity"),c=[],a=[],h="",x=S.join(n,"phpunit.xml");q.existsSync(x)||(x+=".dist");for(let e=0;e<f.length;e++){let i,r=f[e].replace(/\|'/g,'"').replace(/\|n/g,"\n");if(null!=(i=s.exec(r))){let e=i[1].split("\\");c.push(i[3]?{type:"suite",id:fn(c,i[1]),label:i[1],file:i[3],line:dn(e[e.length-1],Yt.readFileSync(i[3],"utf8")),children:[]}:{type:"suite",id:fn(c,i[1]),label:i[1],file:x,children:[]})}else if(null!=(i=u.exec(r)))c.push({type:"test",id:n+"|"+fn(c,i[1]),label:i[1],file:i[3],line:q.existsSync(i[3])?dn(i[1],q.readFileSync(i[3],"utf8")):0});else if(null!=(i=l.exec(r)))0!=c.length&&on(c).label==i[1]&&t.fire({type:"test",test:h=cn(c),state:"failed",message:i[3]+"\n"});else if(null!=(i=o.exec(r)))0!=c.length&&on(c).label==i[1]&&t.fire({type:"test",test:h=cn(c),state:"skipped",message:i[3]+"\n"});else if(null!=(i=p.exec(r))){let e=c.pop();if("test"!=e.type||e.label!=i[1])throw new Error("Something bad happened");let n=e;0!=c.length&&"suite"==on(c).type&&on(c).children.push(n),n.id!=h&&t.fire({type:"test",test:n.id,state:"passed"})}else if(null!=(i=d.exec(r))){let e=c.pop();if("suite"!=e.type||e.label!=i[1])throw new Error("Something bad happened");let n=e;0!=c.length&&"suite"==on(c).type?on(c).children.push(n):a.push(n),t.fire({type:"suite",suite:n.id,state:"completed"})}}return 1!=a.length||r?{type:"suite",id:n,label:S.relative(i,x),file:x,children:a}:a[0]}function dn(e,t){if(!t)return;const n=t.search(en(e));return n<0?void 0:t.substr(0,n).split("\n").length-1}function fn(e,t){return 0!=e.length?on(e).id+"::"+t:t}function cn(e){return 0!=e.length?on(e).id:""}function an(){return e(this,void 0,void 0,function*(){return 0!=(yield r.workspace.findFiles("{**/phpunit.xml,**/phpunit.xml.dist}","{**/vendor/**,.vscode/**,.git/**}",1)).length})}exports.allTests=nn,exports.SearchRecursive=rn,exports.PhpUnitXmlPath=sn,exports.FindPhpUnitXml=un,exports.First=ln,exports.Last=on,exports.TeamcityToSuite=pn,exports.findLineContaining=dn,exports.TestsPresent=an;