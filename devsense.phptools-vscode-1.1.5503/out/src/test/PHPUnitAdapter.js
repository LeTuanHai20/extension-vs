"use strict";var e=this&&this.t||function(t,e,i,s){return new(i||(i=Promise))(function(r,n){function h(t){try{u(s.next(t))}catch(t){n(t)}}function o(t){try{u(s.throw(t))}catch(t){n(t)}}function u(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(h,o)}u((s=s.apply(t,e||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const x=require("child_process"),r=require("vscode"),i=require("./util"),q=require("fs"),si=require("../extension"),S=require("path"),$=require("../Resource");function hi(t){for(var e="",i=0;i<t.length;i++)e+=String.fromCharCode(t[i]);return e}const ui='<?xml version="1.0" encoding="utf-8" ?>\n<phpunit>\n<testsuite name=\'main\'>\n\t<directory suffix=".php">tests</directory>\n</testsuite>\n</phpunit>';class li{constructor(t,e,i){this.workspaceFolder=t,this.log=e,this.context=i,this.disposables=[],this.testStatesEmitter=new r.EventEmitter,this.reloadEmitter=new r.EventEmitter,this.autorunEmitter=new r.EventEmitter,this.St=!1,this.disposables.push(this.testStatesEmitter),this.disposables.push(this.reloadEmitter),this.disposables.push(this.autorunEmitter),this.disposables.push(r.workspace.onDidChangeConfiguration(t=>{this.log.appendLine("Configuration changed");for(const e of li.reloadConfigKeys)if(t.affectsConfiguration(e,this.workspaceFolder.uri))return this.log.appendLine(`Sending reload event because ${e} changed`),void this.reloadEmitter.fire();for(const e of li.autorunConfigKeys)if(t.affectsConfiguration(e,this.workspaceFolder.uri))return this.log.appendLine(`Sending autorun event because ${e} changed`),void this.autorunEmitter.fire()})),this.disposables.push(r.workspace.onDidSaveTextDocument(t=>{const e=t.uri.fsPath;this.log.appendLine(`${e} was saved - checking if this affects ${this.workspaceFolder.uri.fsPath}`),e.startsWith(this.workspaceFolder.uri.fsPath)&&(this.log.appendLine("Sending autorun event"),this.autorunEmitter.fire())}))}get testStates(){return this.testStatesEmitter.event}get reload(){return this.reloadEmitter.event}get autorun(){return this.autorunEmitter.event}load(){return e(this,void 0,void 0,function*(){if(yield this.CheckTests()){let t=yield i.FindPhpUnitXml();if(t&&1==t.length)return yield this.RunTests(null,null,S.dirname(t[0].fsPath),!1,!1);if(t&&t.length>1){let e=[];for(let i=0;i<t.length;i++)e.push(this.RunTests(null,null,S.dirname(t[i].fsPath),!0,!1));return{id:"merged",label:"merged",type:"suite",children:(yield Promise.all(e)).filter(t=>t)}}}})}run(t){return e(this,void 0,void 0,function*(){yield this.SetTestsRunning(t,!1)})}debug(t){return e(this,void 0,void 0,function*(){if("test"==t.type){this.log.appendLine(`Debugging test(s) "${t.id}" of ${this.workspaceFolder.uri.fsPath}`);var e=r.debug.onDidTerminateDebugSession(()=>{this.runningTestProcess&&this.testStatesEmitter.fire({type:"test",test:t.id,state:"skipped"}),e.dispose()});yield r.debug.startDebugging(this.workspaceFolder,{name:"Listen for Xdebug",type:"php",request:"launch",port:9e3});yield this.SetTestsRunning(t,!0),r.commands.executeCommand("workbench.action.debug.stop")}return Promise.resolve()})}cancel(){this.runningTestProcess&&(this.log.appendLine("Killing running test process"),this.runningTestProcess.kill())}dispose(){this.cancel();for(const t of this.disposables)t.dispose();this.disposables=[]}SetTestsRunning(t,e){if("suite"==t.type){this.testStatesEmitter.fire({type:"suite",suite:t.id,state:"running"});let i=t.file.toLowerCase();return i.endsWith(".xml")||i.endsWith(".xml.dist")?this.RunTests(null,t.label,S.dirname(t.file),!0,e):(i.endsWith(".php"),Promise.all(t.children.map(t=>this.SetTestsRunning(t,e))))}{this.testStatesEmitter.fire({type:"test",test:t.id,state:"running"});let s=t.id.split("|"),r=s[1].split("::");return this.RunTests(r.length>1?i.Last(r[r.length-2].split("\\"))+"::"+i.Last(r):i.Last(r),null,s[0],!1,e)}}PhpunitPhar(){let t,e=i.SearchRecursive(this.workspaceFolder.uri.fsPath,"phpunit/phpunit");return t=0==e.length?this.context.extensionPath+"/phpUnit/phpunit-6.5.12.phar":e[0]}CheckTests(){return e(this,void 0,void 0,function*(){let t=yield i.FindPhpUnitXml();if(t&&0!=t.length)return!0;if(!this.St&&(yield i.TestsPresent())){let t=$.GlobalResources.Get().GetString(__filename,"GenerateDefault");if((yield r.window.showInformationMessage($.GlobalResources.Get().GetString(__filename,"PhpunitXmlMissing"),t,$.GlobalResources.Get().GetString(__filename,"Cancel")))==t){let t=i.PhpUnitXmlPath(this.workspaceFolder.uri.fsPath);return q.writeFileSync(t,ui),r.workspace.openTextDocument(t).then(t=>r.window.showTextDocument(t)),this.reloadEmitter.fire(),!0}this.St=!0}return!1})}RunTests(t,e,s,r,n){let h="",o=["-d display_errors=on"];return n&&o.push("-dxdebug.remote_enable=1","-dxdebug.remote_handler=dbgp","-dxdebug.remote_mode=req","-dxdebug.remote_host=127.0.0.1","-dxdebug.remote_port=9000","-dxdebug.remote_autostart=1"),o.push(this.PhpunitPhar()),o.push("--teamcity"),null!=t&&o.push("--filter",'"'+t+'"'),null!=e&&o.push("--testsuite",e),new Promise(t=>{this.runningTestProcess=x.spawn(si.u(),o,{cwd:s,stdio:["pipe","pipe","pipe"]}),this.runningTestProcess.stdout.on("data",t=>{let e=hi(t);h+=e}),this.runningTestProcess.on("close",e=>{this.log.appendLine(h),t(i.TeamcityToSuite(h,this.testStatesEmitter,s,this.workspaceFolder.uri.fsPath,r)),this.runningTestProcess=void 0}),this.runningTestProcess.on("error",e=>{this.log.appendLine(e.message),t()})})}}exports.PHPUnitAdapter=li,li.reloadConfigKeys=["mochaExplorer.files","mochaExplorer.cwd","mochaExplorer.env","mochaExplorer.ui","mochaExplorer.require","mochaExplorer.nodePath"],li.autorunConfigKeys=["mochaExplorer.timeout","mochaExplorer.retries"];